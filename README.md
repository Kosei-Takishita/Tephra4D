# Tephra4D
An advection-diffusion model Tephra4D, a modified model of Tephra2. The principle of this model is explained in the following paper:
    Takishita, K., Poulidis, A.P., Iguchi, M., 2021. Tephra4D: A python-based model for high-resolution tephra transport and deposition simulations— applications at Sakurajima volcano, Japan. Atmosphere (Basel). 12. https://doi.org/10.3390/atmos12030331
The set of the source code consists of the following 4 files:
    tephra4D_interp_wrf-nc.py
      The code that interpolates the netcdf file created via WRF. The utility program setdbs for FALL3D (Costa, et al., 2006) has been reimplemented in python and changed from linear interpolation to cubic spline completion. The input parameter in the WRF netCDF file is:
      PH, PHB, U, V, W, XLONG, XLAT, QVAPOR, P, PB, HGT
      The output parameter in the exported netCDF file is:
      time, lat, lon, alt, x_utm, y_utm, topo, u, v, w, rho
      Time is read and set in advance, so it is not automated. This may be fixed in the near future.
    tephra4D_traj.py
      This code calculates trajectories that represent the average motion of volcanic ash particles discretized by settling velocity and segregation height. The variable names in the netCDF file for wind field data are the same as in the file generated by tephra4D_interp_wrf-nc.py.
      Function “rise” calculates the trajectory during the ascent, i.e. the trailing of the plume.
      Function “traj” calculates the trajectory from the segregation of the plume from the position calculated by “rise” until it lands on the ground. The default set of settling velocity is based on the classification of our disdrometer, and each diameter is calculated from equations 15 and 16 in the paper. We also give a set of segregation heights that equally divide the plume into columns. The trajectories are calculated for each combination of particle size and segregation height. The result is a line by line output of the spatio-temporal coordinates of the particle per step, its velocity, the index of the box it is in, and the time it takes to move to the adjacent box. If the particle returns to the same box as the one it was in two steps before, the velocity component in the direction it went to is set to zero, and the velocity components in other directions are averaged. If the number of lines exceeds 10,000, we save it to a csv file and reset the output DataFrame.
    tephra4D_sites.py
      This is a code to calculate the distribution of ash fall for each observation site. It is under preparation for upload.
    tephra4D_cross.py
      This is a code to calculate the distribution of ash fall for each grid point. It is under preparation for upload.
    
    The input data such as ejecta, eruption start time, plume height(h_p) of each eruption, topography, and wind data has been replaced by dummy data of the same shape, so you will have to get it from elsewhere and substitute it. 
    You can get the topography data around Sakurajima and other Japanese volcanoes from the following GSI website (Japanese): https://fgd.gsi.go.jp/download/menu.php 
    You can get some data related to Sakurajima eruption from the following JMA website (Japanese): http://www.jma-net.go.jp/kagoshima/vol/kazan_top.html 
    If you have trouble calculating using this code, you want the upload to be rushed, or you have a question related to the code, please e-mail to the following address: takishita.kosei.85s@st.kyoto-u.ac.jp

Tephra2を修正して作られた移流拡散モデルTephra4Dです。このモデルの原理は以下の論文で説明されています：
    Takishita, K., Poulidis, A.P., Iguchi, M., 2021. Tephra4D: A python-based model for high-resolution tephra transport and deposition simulations— applications at Sakurajima volcano, Japan. Atmosphere (Basel). 12. https://doi.org/10.3390/atmos12030331
ソースコードのセットは以下の4つのファイルからなります：
    tephra4D_interp_wrf-nc.py
      WRFによって計算された気象場のnetCDFファイルを内挿するコードです。FALL3D(Costa, et al., 2006)のユーティリティプログラムsetdbsをpythonで再実装し，線形内挿から3次スプライン補完に変更しました。インプットパラメータは：
      PH, PHB, U, V, W, XLONG, XLAT, QVAPOR, P, PB, HGT
      出力されるnetCDFファイルのパラメータは：
      time, lat, lon, alt, x_utm, y_utm, topo, u, v, w, rho
      です。時間については事前に読み取って設定していて，自動化できていません。近日中に修正するかもしれません。
    tephra4D_traj.py
      落下速度，分離高度で離散化された火山灰粒子の平均的な動きを表す流跡線を計算するコードです。風速場データのnetCDFファイルの変数名はtephra4D_interp_wrf-nc.pyで生成されたファイルに準じます。
      関数riseでは上昇時の座標移動，すなわち噴煙のなびきを計算します。
      関数trajではriseで計算された噴煙の位置から分離して地表に着地するまでを計算します。shokichiというDataFrameのindexに，落下速度区間を代表する粒径セットをφスケールで与えます。デフォルトに与える落下速度は私達が使用するディスドロメータの落下速度区間に準じていて，論文内の15,16式から計算したものです。また，columnsに噴煙を等分するような分離高度セットを与えます。粒径，分離高度の組み合わせごとに流跡線を計算します。結果は1ステップごとの粒子の時空間座標と移動速度，存在する箱のインデックス，隣接する箱に移動するまでにかかる時間を1行ごとに出力します。計算負荷を考えて，粒子が2ステップ前の箱と同じ箱に戻った場合には，2ステップ前の箱と1ステップ前の箱を合わせて1つの箱と見立てて，行き来した方向の速度成分を0に，その他の方向の速度成分は平均を取って計算します。1万行を超えるとcsvファイルに保存して出力DataFrameをリセットするようにしています。
    tephra4D_sites.py
    観測地点ごとの降灰量分布を計算するコードです。アップロード準備中です。
    tephra4D_cross.py
    格子点ごとの降灰量分布を計算するコードです。アップロード準備中です。

各噴火の噴出量，噴火開始時刻，噴煙高度や，地形データ，風のデータなどの入力値データは同じ形状のダミーデータに置き換えられていますので，他の場所から取得して代入してください。
桜島や他の日本の火山周辺の地形データは以下の国土地理院のサイトから取得できます： https://fgd.gsi.go.jp/download/menu.php
桜島の噴火に関する情報は以下の鹿児島地方気象台のサイトから取得できます： http://www.jma-net.go.jp/kagoshima/vol/kazan_top.html 
もしこのコードを用いて計算する際に問題が生じた場合や，アップロードを急いでほしい場合，このコードに関連した質問がある場合は，以下のメールアドレスにメールしてください： takishita.kosei.85s@st.kyoto-u.ac.jp
